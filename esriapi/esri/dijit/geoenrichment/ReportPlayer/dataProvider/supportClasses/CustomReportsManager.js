// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/CustomReportsManager","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./PortalManager ./ReportTemplateData ./StandardGraphicReportTemplates esri/dijit/geoenrichment/utils/PortalUtil esri/dijit/geoenrichment/utils/PortalQueryUtil esri/dijit/geoenrichment/utils/UrlUtil ../../config".split(" "),function(d,l,n,e,m,p,q,r,t,g,u){var v=d(null,{cache:null,constructor:function(){this.cache=
{}}});d={TEMPLATE_TYPE:"Report Template",PLAYER_STANDARD_INFOGRAPHIC_TYPEKEYWORD:"esriReportPlayerStandardInfographic",_reportsCache:null,resetCache:function(){this._reportsCache=new v},getCustomReports:function(a){var c=this,b=g.getPortalUrl(a.portalUrl);return e(m.getPortalInfo(b),function(f){var h=f.user.username,h={q:t.combineQueryString({type:"Report Template",typeKeywords:a.typeKeywords,owner:!a.publicOnly&&h}),sortField:"modified",sortOrder:"desc"};return r.queryCommon(g.combine(b,"sharing/rest/search"),
h).then(function(b){b=b.map(function(a){return c.prepareCustomReportFromItem(a,f.portal.url)});return c._getCountryReports(b,a.countryID)})})},_getCountryReports:function(a,c){return a&&a.filter(function(a){return!a.countries||a.countries.split(",").some(function(a){return c===a.trim()})})},prepareCustomReportFromItem:function(a,c){var b=l.mixin({},a.properties||a.details);b.isGraphicReport="true"===b.isGraphicReport;b.isMultiFeature="true"===b.isMultiFeature;b.reportID=a.id;a={title:a.title,templateData:c&&
new p(a,c),modified:a.modified instanceof Date?a.modified.getTime():a.modified};l.mixin(a,b);return a},getCustomReportByID:function(a){var c=this,b=this._reportsCache.cache[a.reportID];if(b)return b;b=g.getPortalUrl(a.portalUrl);return this._reportsCache.cache[a.reportID]=e(m.getPortalInfo(b),function(b){return b.user.getItem(a.reportID).then(function(a){return a&&c.prepareCustomReportFromItem(a,b.portal.url)})}).otherwise(function(b){delete c._reportsCache.cache[a.reportID];return a.ignoreError?
null:(new n).reject(b)})},tryFindReportIdByAlias:function(a){var c=this,b=q.aliasToID(a.countryID,a.reportID);if(!b)return null;var f=g.getPortalUrl(a.portalUrl);return e(this.getCustomReportByID({reportID:b,portalUrl:f,ignoreError:!0}),function(b){return b?b.reportID:e(c.getCustomReports({portalUrl:f,countryID:a.countryID,typeKeywords:"esriReportPlayerStandardInfographic",publicOnly:!0},!0),function(b){function c(a){a=a.split(".");return Number((Number(a[0])+Number(a[1])/100).toFixed(2))}var f=c(u.jsapiVersion),
d,e,g=-Infinity,h=Infinity;b.forEach(function(b){if(b.playerAlias===a.reportID){var k=c(b.jsapiVersion);f>=k&&k>g&&(g=k,d=b);f<k&&k<h&&(h=k,e=b)}});return d&&d.reportID||e&&e.reportID})})},itemUpdated:function(a){delete this._reportsCache.cache[a]},getFakeCustomReportByContext:function(a){return{title:"Generic template",type:"esriReportTemplateStandard",coverage:a.countryID,countries:a.countryID,hierarchy:a.hierarchy||"census",isGraphicReport:!0,isMultiFeature:!1,reportID:null}}};d.resetCache();return d});
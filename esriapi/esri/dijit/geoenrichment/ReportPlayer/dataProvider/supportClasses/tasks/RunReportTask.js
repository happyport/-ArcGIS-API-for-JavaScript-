// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/tasks/RunReportTask","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./parsers/DataXMLParser ./EnrichAreasTask ../areas/AnalysisAreaJsonUtil esri/dijit/geoenrichment/utils/ArrayUtil esri/dijit/geoenrichment/ReportPlayer/config esri/dijit/geoenrichment/ReportPlayer/_devConfig".split(" "),function(d,e,n,f,l,p,q,r,t,g,u){var h={_cache:{},_buildKey:function(a){return[a.countryID,
a.hierarchy,JSON.stringify(r.areasToJson(a.analysisAreas,{excludeInfoTemplate:!0})),a.report.reportID,a.report.portalUrl,a.report.modified].join("_")},getCopy:function(a){a=this._buildKey(a);return(a=this._cache[a])&&e.clone(a)},copyAndPut:function(a,b){a=this._buildKey(a);this._cache[a]=b&&e.clone(b)},getResults:function(){var a=[],b;for(b in this._cache)a.push(this._cache[b]);return a}},v={execute:function(a){var b=a.cacheResult&&h.getCopy(a);if(b)return l(b);b=t.splitArrayToBunches(a.analysisAreas,
5);return n(b.map(function(b){function c(){var k=e.mixin({},a,{analysisAreas:b});return(new q).createReport(k).then(function(a){var k=a&&a.taskID;a=a&&a.result;try{u.emulateErrors.createReportError&&(a={error:{message:"Error test: something crashed on the server!"}});var b;a&&"object"===typeof a&&(b=a.error);if(!b&&"string"===typeof a&&-1!==a.indexOf("{"))try{var c=JSON.parse(a);b=c&&c.error}catch(m){}if(b)if(g.runReportTask.ignoreErrors)a=[];else return(new f).reject(b);return{taskID:k,areaData:p.parse(a),
originalXML:a,error:b}}catch(m){return(new f).reject(m)}})}return l(c(),function(a){return!a||a.error?g.runReportTask.secondAttempt?c():a:a},function(a){return g.runReportTask.secondAttempt?c():(new f).reject(a)})})).then(function(b){var c={taskIDs:[],areaData:[],originalXMLs:[],errors:[]};b.forEach(function(a){c.taskIDs.push(a.taskID);c.originalXMLs.push(a.originalXML);a.error&&c.errors.push(a.error);c.areaData=c.areaData.concat(a.areaData)});a.cacheResult&&!c.errors.length&&h.copyAndPut(a,c);return c})}};
d=d(null,{execute:function(a){console.log("Creating a new report...");return v.execute(a)}});d.CreateReportResultCache=h;return d});